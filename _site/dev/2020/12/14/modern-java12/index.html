
<!doctype html>














<html class="theme-next muse use-motion" lang="ko">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/assets/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/assets/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/assets/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="java," />





  <link rel="alternate" href="/atom.xml" title="천천히 걷는 방법" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico?v=5.1.1" />
















<meta name="description" content="모던 자바 인 액션 - 16장 CompletableFuture - 안정적 비동기 프로그래밍">
<meta name="keywords" content="java">
<meta property="og:type" content="article">
<meta property="og:title" content="모던 자바 인 액션 - 16장 CompletableFuture - 안정적 비동기 프로그래밍">
<meta property="og:url" content="http://localhost:4000/dev/2020/12/14/modern-java12/">
<meta property="og:site_name" content="천천히 걷는 방법">
<meta property="og:description" content="모던 자바 인 액션 - 16장 CompletableFuture - 안정적 비동기 프로그래밍">
<meta property="og:locale" content="ko">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="모던 자바 인 액션 - 16장 CompletableFuture - 안정적 비동기 프로그래밍">
<meta name="twitter:description" content="모던 자바 인 액션 - 16장 CompletableFuture - 안정적 비동기 프로그래밍">


<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"hide","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '작성자'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://localhost:4000/"/>





  <title>모던 자바 인 액션 - 16장 CompletableFuture - 안정적 비동기 프로그래밍 | 천천히 걷는 방법</title>
  
















</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="ko">

  
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">천천히 걷는 방법</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">적당히 잘하는 개발자가 되기 위한 기록 저장소</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            홈
          </a>
        </li>
      
        
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            아카이브
          </a>
        </li>
      
        
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            태그
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

<div id="posts" class="posts-expand">
  
  

  

  
  
  

  <article class="post post-type- " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/dev/2020/12/14/modern-java12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="DongChul Lee">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="assets/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="천천히 걷는 방법">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
          
          
            모던 자바 인 액션 - 16장 CompletableFuture - 안정적 비동기 프로그래밍
          
        </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">작성일</span>
              
              <time title="" itemprop="dateCreated datePublished" datetime="2020-12-14T00:00:00+09:00">
                2020-12-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/category/#/dev" itemprop="url" rel="index">
                    <span itemprop="name">dev</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          
            
                <div class="post-description">
                    모던 자바 인 액션 - 16장 CompletableFuture - 안정적 비동기 프로그래밍
                </div>
            
          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
  
  












  <blockquote>
  <p>Modern Java In Action 정리 - CompletableFuture - 안정적 비동기 프로그래밍</p>
</blockquote>

<ul>
  <li>비동기 작업을 만들고 결과 얻기</li>
  <li>비블록 동작으로 생산성 높이기</li>
  <li>비동기 API 설계와 구현</li>
  <li>동기 API를 비동기적으로 소비하기</li>
  <li>두 개 이상의 비동기 연산을 파이프라인으로 만들고 합치기</li>
  <li>비동기 작업 완료에 대응하기</li>
</ul>

<p><code class="highlighter-rouge">모던 자바 인 액션 책을 보고 정리한 글입니다.</code></p>

<h2 id="future의-단순활용">Future의 단순활용</h2>
<ul>
  <li>Java 5 부터 미래의 어느 시점에 결과를 얻는 모델에 활용할수 있도록 Future 인터페이스를 제공하고 있다.</li>
  <li>시간이 걸리는 작업들을 Future 내부에 설정하여 호출자 스레드가 결과를 기다리는 동안 다른 유용한 작업들을 할 수 있다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8</pre></td><td class="code"><pre class="highlight"><code><span class="n">ExecutorService</span> <span class="n">es</span> <span class="o">=</span><span class="n">ex</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
<span class="n">Future</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;()</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="n">Double</span> <span class="nf">call</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">doSomeLongComputation</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">})</span>
<span class="n">doSomeThingElse</span><span class="o">();</span>
<span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span> <span class="c1">// 비동기 결과가 준비되어 있지 않으면 1초간 기다린다. </span>
</code></pre></td></tr></tbody></table></div></div>

<ul>
  <li>위 예재와 같이 시간이 오래 걸리는 작업을 다른 스레드에서 처리하고 메인 스레드에서는 다른 작업들을 미리 수행할 수 있다.</li>
  <li>만약 결과가 준비되지 않았다면 작업이 완료될때까지 스레드를 블록할 수 있다. 이때 영원히 스레드가 종료되지 않는 경우를 대비하여 최대 타임아웃을 설정가능하다.</li>
</ul>

<h3 id="future-제한">Future 제한</h3>
<ul>
  <li>첫번째 예제에서는 Future 인터페이스가 비동기 계산이 끝났는지 확인할수 있는 isDone, 게산이 끝나길 기다리는 메서드, 결과 회수 메서드등을 제공한다. 하지만 이들만으로 동시 실행 코드를 구현하기 어렵다.</li>
  <li>오래걸리는 A 계산이 끝나면 B를 실행하라 와 같은 요구사항을 쉽게 구현할 수 있어야 한다.</li>
  <li>Future로 이와같은 동작을 구현하는것은 쉽지 않다. 다음과 같은 선언형 기능이 있다면 유용하게 사용할 수 있을것이다.
    <ul>
      <li>두 개의 비동기 계산 결과를 하나로 합친다. 두 계산은 하나에 의존하는 상황일수도, 독립적인 계산일수도 있다.</li>
      <li>Future 집합이 샐행하는 모든 테스크의 완료를 기다린다.</li>
      <li>Future 집합에서 가장 빨리 완료되는 테스크를 기다렸다가 결과를 얻는다. (예를 들어 여러 테스크가 다양한 방식으로 같은 결과를 얻는 방법)</li>
      <li>프로그램적으로 Future를 완료 시킨다. (비동기 동작에 수동으로 결과 제공)</li>
      <li>Future 완료 동작에 반응한다. (결과를 기다리며 블록되지 않고 결과가 준비되었다는 알림을 받은 다음 Future의 결과로 원하는 추가 동작을 수행가능)</li>
    </ul>
  </li>
  <li>선언형으로 Future를 사용할 수 있는 CompletableFuture 클래스에 대해 알아본다.</li>
  <li>Stream과 비슷하게 람다표현식과 파이프라이닝을 활용, 따라서 Future와 CompletableFuture는 Collection과 Stream의 관계에 비유가능하다.</li>
</ul>

<h3 id="completablefuture로-비동기-애플리케이션-만들기">CompletableFuture로 비동기 애플리케이션 만들기</h3>
<ul>
  <li>첫쨰. 고객에게 비동기 API를 제공하는 방법을 배운다.</li>
  <li>둘쨰. 동기 API를 사용해야할 때 코드를 비블록으로 만드는 방법을 배운다. 두 개의 비동기 동작을 파이프라인으로 만드는 방법과 두 개의 동작 결과를 하나의 비동기 계산으로 합치는 방법.</li>
  <li>셋째. 비동기 동작의 완료에 대응하는 방법을 배운다.</li>
</ul>

<h2 id="비동기-api-구현">비동기 API 구현</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18</pre></td><td class="code"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Shop</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kt">double</span> <span class="nf">getPrice</span><span class="o">(</span><span class="n">String</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">calculatePrice</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">double</span> <span class="nf">calculatePrice</span><span class="o">(</span><span class="n">String</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">delay</span><span class="o">();</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">Random</span><span class="o">().</span><span class="na">nextDouble</span><span class="o">()</span> <span class="o">*</span> <span class="n">product</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="n">product</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
  <span class="o">}</span>
  
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">delay</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
          <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000L</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></tbody></table></div></div>

<ul>
  <li>getPrice는 외부 요청과 같이 시간이 오래걸리는 작업을 수행 할 수 있으므로 임의로 1초 동안 sleep 메소드를 호출하였다.</li>
  <li>위 API를 사용자가 호출하는 경우 비동기 동작이 완료될때까지 1초 동안 블록된다.</li>
  <li>동기 메소드를 비동기 메소드로 소비하는 방법을 알아보자.</li>
</ul>

<h3 id="동기-메서드를-비동기-메서드로-변환">동기 메서드를 비동기 메서드로 변환</h3>
<ul>
  <li>동기 메서드 getPrice를 비동기 메서드로 변환하려면 이름과 반환값을 변경해야 한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1</pre></td><td class="code"><pre class="highlight"><code><span class="kd">public</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="nf">getPriceAnsync</span><span class="o">(</span><span class="n">String</span> <span class="n">product</span><span class="o">)</span>
</code></pre></td></tr></tbody></table></div></div>

<ul>
  <li>Future는 결과값의 핸들일 뿐 계산이 완료되면 get 메서들르 통해 결과를 얻을 수 있다. 다시말해 getPriceAnsync 메서드는 즉시 반환되고 호출자 스레드는 다른 작업을 수행할 수 있다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10</pre></td><td class="code"><pre class="highlight"><code><span class="kd">public</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="nf">getPriceAnsync</span><span class="o">(</span><span class="n">String</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">futurePrice</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CompletableFuture</span><span class="o">&lt;&gt;();</span>
    
    <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="kt">double</span> <span class="n">price</span> <span class="o">=</span> <span class="n">calculatePrice</span><span class="o">(</span><span class="n">product</span><span class="o">);</span> <span class="c1">// 다른 스레드에서 비동기로 계산 </span>
        <span class="n">futurePrice</span><span class="o">.</span><span class="na">complete</span><span class="o">(</span><span class="n">price</span><span class="o">);</span> <span class="c1">// 결과값 전달</span>
    <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
    
    <span class="k">return</span> <span class="n">futurePrice</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></tbody></table></div></div>

<ul>
  <li>상점은 비동기 API를 제공함으로 즉시 Future를 반환한다. 클라이언트는 전달 받은 Future를 이용하여 적절한 시점에 결과를 얻을 수 있고, 그 동안 다른 작업을 수행 가능하다.</li>
  <li>Future의 get 메서드 호출시 결과값을 가지고 있다면 곧바로 값을 읽지만 그렇지 않으면 계산이 완료될때 까지 블록한다.</li>
</ul>

<h3 id="에러-처리-방법">에러 처리 방법</h3>
<ul>
  <li>가격을 계산하는 동안 에러가 발생하는 경우 해당 쓰레드에만 영향을 미치게 되어 전체적인 결과값이 잘못되거나 클라이언트에서 응답을 무한히 기다리게 될 수 있다.</li>
  <li>클라이언트는 타임아웃 값을 받는 get 메서드를 활용하여 문제를 해결할 수있다. 하지만 일반적으로는 어떠한 이유로 TimeoutException이 발생한지는 알수 없을것이다.</li>
  <li>CompleteExceptionally 메서드를 이용하여 CompletableFuture 내부에서 발생한 예외를 클라이언트로 전달해보자.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14</pre></td><td class="code"><pre class="highlight"><code><span class="kd">public</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="nf">getPriceAnsync</span><span class="o">(</span><span class="n">String</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">futurePrice</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CompletableFuture</span><span class="o">&lt;&gt;();</span>

    <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">double</span> <span class="n">price</span> <span class="o">=</span> <span class="n">calculatePrice</span><span class="o">(</span><span class="n">product</span><span class="o">);</span> <span class="c1">// 다른 스레드에서 비동기로 계산</span>
            <span class="n">futurePrice</span><span class="o">.</span><span class="na">complete</span><span class="o">(</span><span class="n">price</span><span class="o">);</span> <span class="c1">// 결과값 전달</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">futurePrice</span><span class="o">.</span><span class="na">completeExceptionally</span><span class="o">(</span><span class="n">ex</span><span class="o">);</span> <span class="c1">// 문제가 발생하는 경우 에러를 포함시켜 Future를 종료</span>
        <span class="o">}</span>
    <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

    <span class="k">return</span> <span class="n">futurePrice</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></tbody></table></div></div>

<h4 id="팩토리-메서드-supplyasync로-completablefuture-만들기">팩토리 메서드 supplyAsync로 CompletableFuture 만들기</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3</pre></td><td class="code"><pre class="highlight"><code><span class="kd">public</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="nf">getPriceAnsync</span><span class="o">(</span><span class="n">String</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">calculatePrice</span><span class="o">(</span><span class="n">product</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></td></tr></tbody></table></div></div>

<h2 id="비블록-코드-만들기">비블록 코드 만들기</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10</pre></td><td class="code"><pre class="highlight"><code><span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Shop</span><span class="o">&gt;</span> <span class="n">shops</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="k">new</span> <span class="n">Shop</span><span class="o">(</span><span class="s">"shop1"</span><span class="o">),</span> 
            <span class="k">new</span> <span class="nf">Shop</span><span class="o">(</span><span class="s">"shop2"</span><span class="o">),</span> 
            <span class="k">new</span> <span class="nf">Shop</span><span class="o">(</span><span class="s">"shop3"</span><span class="o">),</span>
            <span class="k">new</span> <span class="nf">Shop</span><span class="o">(</span><span class="s">"shop4"</span><span class="o">));</span>

<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">findPrices</span><span class="o">(</span><span class="n">String</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">shops</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">shop</span> <span class="o">-&gt;</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s is %.2f"</span><span class="o">,</span> <span class="n">shop</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">shop</span><span class="o">.</span><span class="na">getPrice</span><span class="o">(</span><span class="n">product</span><span class="o">)))</span>
            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></tbody></table></div></div>

<ul>
  <li>위와 같은 예제를 실행한다면 shops의 수 만큼 price를 순차적으로 계산하게 되어 많은 시간이 소요될 것이다.</li>
</ul>

<h3 id="병렬-스트림으로-요청-병렬화-하기">병렬 스트림으로 요청 병렬화 하기</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5</pre></td><td class="code"><pre class="highlight"><code><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">findPrices</span><span class="o">(</span><span class="n">String</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">shops</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">()</span>
            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">shop</span> <span class="o">-&gt;</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s is %.2f"</span><span class="o">,</span> <span class="n">shop</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">shop</span><span class="o">.</span><span class="na">getPrice</span><span class="o">(</span><span class="n">product</span><span class="o">)))</span>
            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></tbody></table></div></div>

<ul>
  <li>병렬 스트림을 이용하여 동시에 가격을 계산할 수 있도록 개선하면 시간이 단축된다.</li>
  <li>다음은 CompletableFuture를 활용하여 findPrices 메서드의 동기 호출을 비동기 호출로 변경해보자.</li>
</ul>

<h3 id="completablefuture로-비동기-호출-구현하기">CompletableFuture로 비동기 호출 구현하기</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11</pre></td><td class="code"><pre class="highlight"><code><span class="c1">// 팩토리 메서드를 활용</span>
<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">findPrices</span><span class="o">(</span><span class="n">String</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">priceFutures</span> <span class="o">=</span> <span class="n">shops</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">shop</span> <span class="o">-&gt;</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"%s is %.2f"</span><span class="o">,</span> <span class="n">shop</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">shop</span><span class="o">.</span><span class="na">getPrice</span><span class="o">(</span><span class="n">product</span><span class="o">))))</span>
            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>


    <span class="k">return</span> <span class="n">priceFutures</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">CompletableFuture:</span><span class="o">:</span><span class="n">join</span><span class="o">)</span>
            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></tbody></table></div></div>

<ul>
  <li>CompletableFuture 리스트를 만든 후 계산이 끝난 결과를 추출하는 예시이다. CompletableFuture의 join메서드를 활용했는데 Future의 get 메서드와 같은 의미를 갖는다.</li>
  <li>다른점으로는 join 메서드는 예외를 발생시키지 않는다는 점이다.</li>
  <li>두 map연산을 하나의 스트림 파이프라인으로 처리하지 않고 분리했다는것에 주목하자. 스트림 연산은 Lazy한 방식으로 동작하기 때문에 하나의 파이프 라인으로 처리했다면 순차적으로 실행되게 된다.</li>
</ul>

<h3 id="확장성이-더-좋은-해결-방법">확장성이 더 좋은 해결 방법</h3>
<ul>
  <li>병렬 스트림 버전의 코드는 지정한 숫자의 상점에 하나의 스레드를 할당하여 네 개의 작업을 병렬로 처리하였다. 상점이 추가되는 경우는 어떻게 될까 ? (스레드 갯수는 4개가 최대라고 제한)</li>
  <li>순차 실행인 경우는 5초 이상, 병렬 스트림, CompletableFuture를 사용한 경우 2초 이상이 소모 될것이다.</li>
  <li>병렬 스트림과 CompletableFuture는 비슷한 결과를 보이지만 CompletableFuture는 병렬 스트림에 비해 작업에 사용할 다양한 Executor를 지정할 수 있다.</li>
</ul>

<h3 id="커스텀-executor-사용하기">커스텀 Executor 사용하기</h3>
<ul>
  <li>애플리케이션에서 사용하는 자원을 고려하여 풀에서 관리하는 최적의 스레드 수에 맞게 Executor를 만드는 것이 효율적일것이다.</li>
  <li>스레드가 너무 많을수록 사용하지 않는 스레드가 많아지고 서버가 크래시 날 수 있으므로 적정한 갯수를 지정하는것이 중요하다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8</pre></td><td class="code"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">final</span> <span class="n">Executor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">shops</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="mi">100</span><span class="o">),</span> <span class="k">new</span> <span class="n">ThreadFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Thread</span> <span class="nf">newThread</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="n">t</span><span class="o">.</span><span class="na">setDaemon</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span> <span class="c1">// 프로그램 종료를 방해하지 않는 데몬 스레드를 사용.</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">});</span>
</code></pre></td></tr></tbody></table></div></div>

<h2 id="비동기-작업-파이프라인-만들기">비동기 작업 파이프라인 만들기</h2>
<ul>
  <li>상점이 하나의 할인 서비스를 사용한다고 가정, 다음과 같이 구현할 수 있다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18</pre></td><td class="code"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Discount</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">enum</span> <span class="n">Code</span> <span class="o">{</span>
      <span class="n">NONE</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">SILVER</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="n">GOLD</span><span class="o">(</span><span class="mi">10</span><span class="o">),</span> <span class="n">PLATINUM</span><span class="o">(</span><span class="mi">15</span><span class="o">),</span> <span class="n">DIAMOND</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
      
      <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">percentage</span><span class="o">;</span>

      <span class="n">Code</span><span class="o">(</span><span class="kt">int</span> <span class="n">percentage</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">this</span><span class="o">.</span><span class="na">percentage</span> <span class="o">=</span> <span class="n">percentage</span><span class="o">;</span>
      <span class="o">}</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="n">String</span> <span class="nf">getPrice</span><span class="o">(</span><span class="n">String</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">double</span> <span class="n">price</span> <span class="o">=</span> <span class="n">calculatePrice</span><span class="o">(</span><span class="n">product</span><span class="o">);</span>
    <span class="n">Discount</span><span class="o">.</span><span class="na">Code</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Discount</span><span class="o">.</span><span class="na">Code</span><span class="o">.</span><span class="na">values</span><span class="o">()[</span><span class="k">new</span> <span class="n">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">Discount</span><span class="o">.</span><span class="na">Code</span><span class="o">.</span><span class="na">values</span><span class="o">().</span><span class="na">length</span><span class="o">)];</span>
    <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"$s %.2f $s"</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">price</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></tbody></table></div></div>

<h3 id="할인-서비스-구현">할인 서비스 구현</h3>

<ul>
  <li>할인 정보는 언제든 변경될 수 있으므로 매번 서버에서 받아오는걸로 가정</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13</pre></td><td class="code"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Discount</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">enum</span> <span class="n">Code</span> <span class="o">{</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">applyDiscount</span><span class="o">(</span><span class="n">Quote</span> <span class="n">quote</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">quote</span><span class="o">.</span><span class="na">getShopName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"price is "</span> <span class="o">+</span> <span class="n">Discount</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">quote</span><span class="o">,</span><span class="n">getPrice</span><span class="o">,</span> <span class="n">quote</span><span class="o">.</span><span class="na">getDiscountCoe</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">double</span> <span class="nf">apply</span><span class="o">(</span><span class="kt">double</span> <span class="n">price</span><span class="o">,</span> <span class="n">Code</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">delay</span><span class="o">();</span>
    <span class="k">return</span> <span class="nf">format</span><span class="o">(</span><span class="n">price</span> <span class="o">*</span> <span class="o">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">code</span><span class="o">.</span><span class="na">percentage</span><span class="o">)</span> <span class="o">/</span> <span class="mi">100</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></tbody></table></div></div>

<h3 id="할인-서비스-사용">할인 서비스 사용</h3>

<ul>
  <li>Discount 서비스는 원격 서비스이므로 1초의 지연을 추가.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7</pre></td><td class="code"><pre class="highlight"><code><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">findPrices</span><span class="o">(</span><span class="n">String</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">shops</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
              <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">shop</span> <span class="o">-&gt;</span> <span class="n">shop</span><span class="o">.</span><span class="na">getPrice</span><span class="o">(</span><span class="n">product</span><span class="o">))</span>
              <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Quote:</span><span class="o">:</span><span class="n">parse</span><span class="o">)</span>
              <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Discount:</span><span class="o">:</span><span class="n">applyDiscount</span><span class="o">)</span>
              <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></tbody></table></div></div>
<ul>
  <li>세게의 map 연산을 사용하여 상점 스트림에 파이프라인으로 원하는 결과를 얻었지만 성능 최적화와는 거리가 먼 코드이다.</li>
  <li>병렬 스트림으로 개선한다면 성능이 좋아지겠지만 스레드 풀의 크기가 고정되어 있다는 단점으로 인해 CompletableFuture에서 수행하는 커스텀 Executor를 정의해보자.</li>
</ul>

<h3 id="동기-작업과-비동기-작업-조합하기">동기 작업과 비동기 작업 조합하기</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12</pre></td><td class="code"><pre class="highlight"><code><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">findPrices</span><span class="o">(</span><span class="n">String</span> <span class="n">product</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">priceFutures</span> <span class="o">=</span> 
    <span class="n">shops</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
          <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">shop</span> <span class="o">-&gt;</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">shop</span><span class="o">.</span><span class="na">getPrice</span><span class="o">(</span><span class="n">product</span><span class="o">),</span> <span class="n">executor</span><span class="o">))</span>
          <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">future</span> <span class="o">-&gt;</span> <span class="n">future</span><span class="o">.</span><span class="na">thenApply</span><span class="o">(</span><span class="nl">Quote:</span><span class="o">:</span><span class="n">parse</span><span class="o">))</span>
          <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">future</span> <span class="o">-&gt;</span> <span class="n">future</span><span class="o">.</span><span class="na">thenCompose</span><span class="o">(</span><span class="n">quote</span> <span class="o">-&gt;</span> <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">Discoount</span><span class="o">.</span><span class="na">applyDiscount</span><span class="o">(</span><span class="n">qoute</span><span class="o">),</span> <span class="n">executor</span><span class="o">)))</span>
          <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">());</span>

  <span class="k">return</span> <span class="n">priceFutures</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                      <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">CompletableFuture:</span><span class="o">:</span><span class="n">join</span><span class="o">)</span>
                      <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></td></tr></tbody></table></div></div>

<ul>
  <li><strong>가격 정보 얻기</strong>
    <ul>
      <li>첫번째 연산에서 supplyAsync에 닮다 표현식을 전달하여 비동기적으로 상점에서 정보를 조회 했다. 첫번째 반환 결과는 Stream&lt;CompletableFuture<String> 이다.</String></li>
    </ul>
  </li>
  <li><strong>Quote 파싱</strong>
    <ul>
      <li>두번째 변환 과정은 문자열을 파싱하기 위한 Quote 객체를 만든다. 이 과정은 원격 서비스를 이용하지 않기 때문에 thenApply를 활용하여 즉시 지연없이 실행한다.</li>
      <li>thenApply 메서드는 CompletableFuture가 끝날때가지 블록하지 않는다는 점을 주의한다. 즉 CompletableFuture가 동작을 완전히 완료한 다음 thenApply 메서드로 전달된 람다 표현식을 적용할 수 있다.</li>
      <li>따라서 반환 결과값은 Stream&lt;CompletableFuture<Quote> 이다.</Quote></li>
    </ul>
  </li>
  <li><strong>CompletableFuture를 조합하여 할인된 가격 계산</strong>
    <ul>
      <li>세번째 연산에서는 Discount 서비스를 활용하여 할인된 가격을 계산해야 한다.</li>
      <li>람다표현식으로 이 동작을 supplyAsync에 전달할 수 있다. 그러면 다른 CompletableFuture가 반환 되어 결과적으로 두가지 CompletableFuture로 이루어진 비동기 동작을 만들수 있다.
        <ul>
          <li>상점에서 가격정보를 얻어와 Quote로 변환</li>
          <li>변환된 Quote를 Discount서비스로 전달하여 할인된 최종 가격 획득</li>
        </ul>
      </li>
      <li>thenCompose 메서드는 첫 번째 연산의 결과를 두번째 연산으로 전달한다. 즉 첫 번째 CompletableFuture에 thenCompose를 호출하고, Function을 넘겨주는 식으로 두 CompletableFuture를 조합할 수 있다.</li>
      <li>Function은 첫 번째 CompletableFuture 반환 결과를 인수로 받고 두 번째 CompletableFuture를 반환하는데 두번째 CompletableFuture는 첫 번째 CompletableFuture의 결과를 계산의 입력으로 사용한다.</li>
    </ul>
  </li>
</ul>

<h3 id="독립-completablefuture와-비독립-completablefuture-합치기">독립 CompletableFuture와 비독립 CompletableFuture 합치기</h3>
<ul>
  <li>독립적으로 실행된 두 개의 CompletableFuture 결과를 합쳐야 하는 경우를 살펴보자, 첫 번째 CompletableFuture의 완료와는 관계없이 두 번째 CompletableFuture를 실행할 수 있어야 한다.</li>
  <li>thenCombine 메서드를 사용하여 해결할 수 있다. thenCombine 메서드는 BiFunction을 두 번째 인수로 받는다.</li>
  <li>thenCompose와 마찬가지로 thenCombine 메서드에도 Async 버전이 존재. thenCombineAsync 메서드에서는 BiFunction이 정의하는 동작이 스레드 풀로 제출될 경우 별도의 태스크에서 비동기적으로 수행된다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4</pre></td><td class="code"><pre class="highlight"><code><span class="n">Future</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span> <span class="n">futurePriceInUSD</span> <span class="o">=</span> 
  <span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">shop</span><span class="o">.</span><span class="na">getPrice</span><span class="o">(</span><span class="n">product</span><span class="o">))</span> <span class="c1">// 제품가격을 요청하는 첫번째 테스크 생성.</span>
                   <span class="o">.</span><span class="na">thenCombie</span><span class="o">(</span><span class="n">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">exchangeService</span><span class="o">.</span><span class="na">getRate</span><span class="o">(</span><span class="n">Money</span><span class="o">.</span><span class="na">EUR</span><span class="o">,</span> <span class="n">Money</span><span class="o">.</span><span class="na">USD</span><span class="o">)),</span> <span class="o">(</span><span class="n">price</span><span class="o">,</span> <span class="n">rate</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">price</span> <span class="o">*</span> <span class="n">rate</span><span class="o">)</span> <span class="c1">// USD, EUR의 환율 정보를 요청하는 독립적인 두 번째 테스크 생성.</span>
                   <span class="o">.</span><span class="na">orTimeOut</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span> <span class="c1">// 3초 뒤 작업이 완료되지 않으면 TimeoutException을 발생시키도록 설정</span>
</code></pre></td></tr></tbody></table></div></div>
<ul>
  <li>무한정 대기하는것을 막기 위해 TimeOut을 설정할 수 있다. 또한 completeOnTimeOut 메서드를 사용한다면 특정 시간안에 응답이 오지 않는 경우 기본값을 전달할 수있다. completeOnTimeOut의 반환값은 CompletableFuture이므로 파이프라인의 실행은 유지될 것이다.</li>
</ul>



      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            
            <a href="/tag/#/java" rel="tag"># java</a>
          
        </div>
      

      
      
      
      
      

      
      
        <div class="post-nav" id="post-nav-id">
          <div class="post-nav-next post-nav-item">
            
              <a href="/dev/2020/12/24/modern-java13/" rel="next" title="모던 자바 인 액션 - 17장 리액티브 프로그래밍">
                <i class="fa fa-chevron-left"></i> 모던 자바 인 액션 - 17장 리액티브 프로그래밍
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/dev/2020/12/06/modern-java11/" rel="prev" title="모던 자바 인 액션 - 15장 CompletableFuture와 리액티브 프로그래밍 컨셉의 기초">
                모던 자바 인 액션 - 15장 CompletableFuture와 리액티브 프로그래밍 컨셉의 기초 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      
      

      
    </footer>
  </article>

  <div class="post-spread">
    
  </div>
</div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          

  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        
        
        







      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            목차
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            흝어보기
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/assets/images/avatar.gif"
               alt="DongChul Lee" />
          <p class="site-author-name" itemprop="name">DongChul Lee</p>
           
              <p class="site-description motion-element" itemprop="description">사내 공유, 개인의 경험을 기록하는 블로그입니다.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">44</span>
                <span class="site-state-item-name">포스트</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">카테고리</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">태그</span>
              </a>
            </div>
          

        </nav>

        
        
        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              
              
              <span class="links-of-author-item">
                <a href="https://github.com/sah3122" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            








            
              <div class="post-toc-content">
    <ol class=nav>
      <li class="nav-item nav-level-2"> <a class="nav-link" href="#future의-단순활용"> <span class="nav-number">1</span> <span class="nav-text">Future의 단순활용</span> </a> <ol class="nav-child"> <li class="nav-item nav-level-3"> <a class="nav-link" href="#future-제한"> <span class="nav-number">1.1</span> <span class="nav-text">Future 제한</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#completablefuture로-비동기-애플리케이션-만들기"> <span class="nav-number">1.2</span> <span class="nav-text">CompletableFuture로 비동기 애플리케이션 만들기</span> </a> </li> </ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#비동기-api-구현"> <span class="nav-number">2</span> <span class="nav-text">비동기 API 구현</span> </a> <ol class="nav-child"> <li class="nav-item nav-level-3"> <a class="nav-link" href="#동기-메서드를-비동기-메서드로-변환"> <span class="nav-number">2.1</span> <span class="nav-text">동기 메서드를 비동기 메서드로 변환</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#에러-처리-방법"> <span class="nav-number">2.2</span> <span class="nav-text">에러 처리 방법</span> </a> <ol class="nav-child"> <li class="nav-item nav-level-4"> <a class="nav-link" href="#팩토리-메서드-supplyasync로-completablefuture-만들기"> <span class="nav-number">2.2.1</span> <span class="nav-text">팩토리 메서드 supplyAsync로 CompletableFuture 만들기</span> </a> </li> </ol> </li> </ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#비블록-코드-만들기"> <span class="nav-number">3</span> <span class="nav-text">비블록 코드 만들기</span> </a> <ol class="nav-child"> <li class="nav-item nav-level-3"> <a class="nav-link" href="#병렬-스트림으로-요청-병렬화-하기"> <span class="nav-number">3.1</span> <span class="nav-text">병렬 스트림으로 요청 병렬화 하기</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#completablefuture로-비동기-호출-구현하기"> <span class="nav-number">3.2</span> <span class="nav-text">CompletableFuture로 비동기 호출 구현하기</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#확장성이-더-좋은-해결-방법"> <span class="nav-number">3.3</span> <span class="nav-text">확장성이 더 좋은 해결 방법</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#커스텀-executor-사용하기"> <span class="nav-number">3.4</span> <span class="nav-text">커스텀 Executor 사용하기</span> </a> </li> </ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#비동기-작업-파이프라인-만들기"> <span class="nav-number">4</span> <span class="nav-text">비동기 작업 파이프라인 만들기</span> </a> <ol class="nav-child"> <li class="nav-item nav-level-3"> <a class="nav-link" href="#할인-서비스-구현"> <span class="nav-number">4.1</span> <span class="nav-text">할인 서비스 구현</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#할인-서비스-사용"> <span class="nav-number">4.2</span> <span class="nav-text">할인 서비스 사용</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#동기-작업과-비동기-작업-조합하기"> <span class="nav-number">4.3</span> <span class="nav-text">동기 작업과 비동기 작업 조합하기</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#독립-completablefuture와-비독립-completablefuture-합치기"> <span class="nav-number">4.4</span> <span class="nav-text">독립 CompletableFuture와 비독립 CompletableFuture 합치기</span> </a> </li> </ol> </li>
    </ol>
  </div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>

        
        
      <div id="disqus_thread"></div>
      <script>

      /**
      *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
      *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
      /*
      var disqus_config = function () {
      this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
      this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };
      */
      (function() { // DON'T EDIT BELOW THIS LINE
      var d = document, s = d.createElement('script');
      s.src = 'https://sah3122.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
      })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          
      </div>
    </main>       

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">DongChul Lee</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://jekyllrb.com">Jekyll</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/simpleyyt/jekyll-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>





















  
   
  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/jquery/index.js?v=2.1.3"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/assets/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/assets/js/src/motion.js?v=5.1.1"></script>



  
  

  <script type="text/javascript" src="/assets/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/assets/js/src/post-details.js?v=5.1.1"></script>


  


  <script type="text/javascript" src="/assets/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  











  




  

    

  







  






  

  

  
  


  

  
  <script type="text/javascript" src="/assets/js/src/js.cookie.js?v=5.1.1"></script>
  <script type="text/javascript" src="/assets/js/src/scroll-cookie.js?v=5.1.1"></script>


  

</body>
</html>

